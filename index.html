<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Loop2Go v3 — Piano Roll</title>
<style>
  :root{
    --bg:#0b1220; --neon:#20e0ff; --neon2:#9be7ff; --ok:#2be675; --warn:#ffd33d; --blend:#ff9a2b; --muted:#ff3b57;
    --step-off:#1e2d4d; --step-on:#1b5e20; --text:#dff7ff; --glow:#ff3b8d;
    --panel:linear-gradient(180deg,rgba(15,26,49,0.95),rgba(9,16,33,0.95));
  }
  *{box-sizing:border-box; user-select: none; -webkit-user-select: none;}
  body{margin:0;padding:16px;background:radial-gradient(1200px 600px at 30% -10%, #0b274b 0%, #0b1220 42%, #000 100%);color:var(--text);font-family:Inter,system-ui,sans-serif}
  
  /* Header & Global Controls */
  header { max-width: 900px; margin: 0 auto; }
  h1{margin:0 0 4px;font-size:20px;color:var(--neon2);text-align:center; letter-spacing: 1px; text-transform: uppercase;}
  .sub{ text-align:center;font-size:13px;opacity:0.7;margin-bottom:20px; max-width: 600px; margin-left: auto; margin-right: auto; line-height: 1.4; }
  
  .global-controls { 
    display:flex; align-items:center; justify-content:center; gap:16px; margin-bottom:20px; flex-wrap:wrap;
    background: rgba(32,224,255,0.05); padding: 12px; border-radius: 16px; border: 1px solid rgba(32,224,255,0.1);
  }
  .control-group { display: flex; align-items: center; gap: 8px; }
  .label { font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: var(--neon); opacity: 0.8; }
  
  .btn{border:1px solid rgba(32,224,255,0.25);background:rgba(32,224,255,0.05);color:var(--neon);padding:8px 16px;border-radius:6px;cursor:pointer;transition:all 0.1s}
  .btn:hover{background:rgba(32,224,255,0.15); box-shadow: 0 0 15px rgba(32,224,255,0.2);}
  .btn.active { background: var(--neon); color: #000; box-shadow: 0 0 20px var(--neon); border-color: var(--neon); }

  input[type=number]{width:60px;text-align:center;border:1px solid rgba(32,224,255,0.3);background:#000;color:var(--neon);padding:6px;border-radius:4px; font-weight: bold;}
  input[type=range] { accent-color: var(--neon); cursor: pointer; }

  /* Mixer / Strips */
  .mixer{display:flex;gap:16px;overflow-x:auto;padding:10px 4px 20px; max-width: 100%; scroll-behavior: smooth;}
  
  .strip{
    flex:0 0 300px; scroll-snap-align:start; background:var(--panel);
    border:1px solid rgba(32,224,255,0.15); border-radius:12px; padding:14px;
    box-shadow:0 10px 30px rgba(0,0,0,0.5); position: relative;
  }
  
  .strip-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
  .strip h2{margin:0;font-size:14px;color:var(--neon2); letter-spacing: 1px;}
  
  .tool-btn { font-size: 10px; padding: 4px 8px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: #fff; border-radius: 4px; cursor: pointer; }
  .tool-btn:hover { background: rgba(255,255,255,0.15); }
  .tool-btn.primary { border-color: var(--neon); color: var(--neon); font-weight: bold; }

  /* Knobs & Mute */
  .controls-row{display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:12px; background: rgba(0,0,0,0.2); padding: 8px; border-radius: 8px;}
  .knob-wrap{width:70px;text-align:center}
  canvas.knob{width:50px;height:50px;display:block;margin:0 auto 4px;cursor:ns-resize}
  .readout{font-size:10px;color:var(--ok); font-family: monospace;}
  
  .mute{width:100%; font-size: 11px; border:1px solid var(--muted);color:var(--muted);background:transparent;padding:6px;border-radius:4px;cursor:pointer; text-transform: uppercase;}
  .mute.muted{background:var(--muted);color:#fff;box-shadow:0 0 10px var(--muted);}

  /* Grid */
  .grid-wrap { overflow-x: auto; padding-bottom: 5px; }
  .grid{display:grid;grid-template-columns:repeat(16,1fr); gap:2px; min-width: 100%; }
  
  .cell{
    aspect-ratio: 1; background:var(--step-off); border-radius:2px;
    cursor:pointer; transition:background 0.05s; position: relative;
  }
  .cell:nth-child(4n+1) { border-left: 1px solid rgba(255,255,255,0.15); }
  .cell.active{background:var(--step-on); box-shadow: inset 0 0 8px rgba(43, 230, 117, 0.4);}
  .cell.playhead{ background:var(--blend) !important; transform: scale(1.1); z-index: 10; box-shadow: 0 0 10px var(--blend); border-radius: 4px;}
  .cell.glow{ background: #fff !important; box-shadow: 0 0 20px #fff; z-index: 11; transition: none; }
  .cell.beyond{opacity:0.15; pointer-events: none; background: #000;}

  /* Loop Controls */
  .loop-controls{display:flex;align-items:center;justify-content:space-between; margin-top:12px; background: rgba(0,0,0,0.3); padding: 6px; border-radius: 6px;}
  .loop-val { font-family: monospace; color: var(--warn); font-size: 14px; }

  /* PIANO ROLL MODAL */
  .modal-overlay {
    position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.85);
    z-index: 100; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px);
  }
  .modal-overlay.open { display: flex; }
  .piano-roll {
    width: 90%; max-width: 800px; height: 80vh; background: #131d2e; border: 1px solid var(--neon);
    border-radius: 12px; display: flex; flex-direction: column; overflow: hidden;
    box-shadow: 0 0 50px rgba(32,224,255,0.15);
  }
  .piano-header { padding: 12px; background: rgba(32,224,255,0.1); display: flex; justify-content: space-between; align-items: center; }
  .piano-header h3 { margin: 0; color: var(--neon); }
  .piano-body { flex: 1; overflow: auto; padding: 10px; display: flex; flex-direction: column; gap: 2px; }
  
  .pr-row { display: flex; height: 30px; align-items: center; }
  .pr-key { 
    width: 60px; flex-shrink: 0; font-size: 11px; color: #fff; background: rgba(255,255,255,0.05); 
    height: 100%; display: flex; align-items: center; padding-left: 8px; border-bottom: 1px solid #222;
  }
  .pr-key.black { background: rgba(0,0,0,0.3); color: #aaa; }
  
  .pr-grid { display: flex; flex: 1; height: 100%; gap: 1px; }
  .pr-cell {
    flex: 1; background: #1a2639; border-right: 1px solid #2a3d5e; border-bottom: 1px solid #2a3d5e;
    cursor: pointer; position: relative;
  }
  .pr-cell:nth-child(4n+1) { background: #202e45; }
  .pr-cell.active { background: var(--step-on); border: 1px solid var(--ok); box-shadow: 0 0 8px var(--step-on); }
  .pr-cell.active::after { content:''; position: absolute; top: 2px; bottom: 2px; left: 2px; right: 2px; background: rgba(255,255,255,0.2); }
  .pr-cell.playhead { background: rgba(255, 154, 43, 0.3) !important; }

  /* Scrollbars */
  ::-webkit-scrollbar { height: 8px; width: 8px; }
  ::-webkit-scrollbar-track { background: #0b1220; }
  ::-webkit-scrollbar-thumb { background: #1e3a5f; border-radius: 4px; }
</style>
</head>
<body>
  <header>
    <h1>Loop2Go v3</h1>
    <div class="sub">Piano Roll Added. Click <b>EDIT</b> on Bass/Perc tracks to draw melodies.</div>
  </header>

  <div class="global-controls">
    <div class="control-group">
      <button id="playBtn" class="btn">PLAY</button>
      <button id="stopBtn" class="btn">STOP</button>
    </div>
    <div class="control-group">
      <span class="label">BPM</span>
      <button id="bpmDown" class="tool-btn">−</button>
      <input id="bpmInput" type="number" min="40" max="240" value="120" />
      <button id="bpmUp" class="tool-btn">+</button>
    </div>
    <div class="control-group">
      <span class="label">Swing</span>
      <input type="range" id="swingInput" min="0" max="0.5" step="0.05" value="0" style="width:80px">
    </div>
    <div class="control-group">
      <span class="label">Echo</span>
      <input type="range" id="echoInput" min="0" max="0.6" step="0.01" value="0.2" style="width:80px">
    </div>
  </div>

  <div class="mixer" id="mixer"></div>

  <div class="modal-overlay" id="pianoModal">
    <div class="piano-roll">
      <div class="piano-header">
        <h3 id="prTitle">Bass Editor</h3>
        <button class="btn" onclick="closePianoRoll()">Done</button>
      </div>
      <div class="piano-body" id="prBody">
        </div>
    </div>
  </div>

<script>
/* ================= AUDIO CORE ================= */
const AudioCtx = window.AudioContext || window.webkitAudioContext;
const audioCtx = new AudioCtx();

// Master Chain
const limiter = audioCtx.createDynamicsCompressor();
limiter.threshold.value = -10;
limiter.ratio.value = 12;
limiter.connect(audioCtx.destination);

// Send FX
const delayInput = audioCtx.createGain();
const delayNode = audioCtx.createDelay(); delayNode.delayTime.value = 0.375;
const delayFeedback = audioCtx.createGain(); delayFeedback.gain.value = 0.4;
const delayFilter = audioCtx.createBiquadFilter(); delayFilter.type = 'lowpass'; delayFilter.frequency.value = 2000;

delayInput.connect(delayNode);
delayNode.connect(delayFeedback);
delayFeedback.connect(delayNode);
delayFeedback.connect(delayFilter);
delayFilter.connect(limiter);

const echoSlider = document.getElementById('echoInput');
delayInput.gain.value = parseFloat(echoSlider.value);
echoSlider.addEventListener('input', e => delayInput.gain.setTargetAtTime(parseFloat(e.target.value), audioCtx.currentTime, 0.02));

/* ================= DATA & SCALES ================= */
// C Minor Pentatonic Scale
const SCALE_LABELS = ['C4', 'A#3', 'G3', 'F3', 'D#3', 'C3'];
const SCALE_FREQS  = [261.63, 233.08, 196.00, 174.61, 155.56, 130.81];

const CHANNEL_DEFS = [
  {id:'kick', title:'Kick', type:'kick', color:'#f72585', melodic: false},
  {id:'bass', title:'Bass', type:'fm', color:'#4361ee', melodic: true},
  {id:'hat',  title:'Hi-Hats', type:'noise', color:'#ffd60a', melodic: false},
  {id:'perc', title:'Perc', type:'pluck', color:'#7209b7', melodic: true}
];

// Global State
let channels = [];
let currentEditChannel = null;

/* ================= SYNTHESIS ENGINE ================= */
function triggerSound(type, time, dest, freqOverride){
  if(type === 'kick'){
    const o = audioCtx.createOscillator(); 
    const g = audioCtx.createGain();
    o.frequency.setValueAtTime(150, time);
    o.frequency.exponentialRampToValueAtTime(0.01, time + 0.5);
    g.gain.setValueAtTime(1.0, time);
    g.gain.exponentialRampToValueAtTime(0.001, time + 0.5);
    o.connect(g).connect(dest);
    o.start(time); o.stop(time + 0.5);
  }
  else if(type === 'noise'){
    const dur = 0.1;
    const buf = audioCtx.createBuffer(1, audioCtx.sampleRate * dur, audioCtx.sampleRate);
    const d = buf.getChannelData(0);
    for(let i=0; i<d.length; i++) d[i] = (Math.random()*2 - 1);
    const src = audioCtx.createBufferSource(); src.buffer = buf;
    const f = audioCtx.createBiquadFilter(); f.type = 'highpass'; f.frequency.value = 6000;
    const g = audioCtx.createGain();
    g.gain.setValueAtTime(0.4, time);
    g.gain.exponentialRampToValueAtTime(0.001, time + 0.05);
    src.connect(f).connect(g).connect(dest);
    src.start(time); src.stop(time+dur);
  }
  else if(type === 'fm'){
    const dur = 0.3;
    const f = freqOverride || 130.81; 
    const car = audioCtx.createOscillator(); car.type='triangle'; car.frequency.value = f;
    const mod = audioCtx.createOscillator(); mod.type='sine'; mod.frequency.value = f * 2;
    const modG = audioCtx.createGain(); modG.gain.value = 300;
    const g = audioCtx.createGain();
    
    mod.connect(modG).connect(car.frequency);
    car.connect(g).connect(dest);
    g.gain.setValueAtTime(0.6, time);
    g.gain.setTargetAtTime(0, time, 0.1);
    modG.gain.setValueAtTime(300, time);
    modG.gain.exponentialRampToValueAtTime(1, time + 0.2);
    car.start(time); mod.start(time);
    car.stop(time+dur); mod.stop(time+dur);
  }
  else if(type === 'pluck'){
    const dur = 0.4;
    const f = freqOverride || 196.00;
    const o = audioCtx.createOscillator(); o.type = 'sawtooth'; o.frequency.value = f;
    const filter = audioCtx.createBiquadFilter(); filter.type='lowpass';
    const g = audioCtx.createGain();
    filter.frequency.setValueAtTime(f * 4, time);
    filter.frequency.exponentialRampToValueAtTime(f, time + 0.2);
    g.gain.setValueAtTime(0.3, time);
    g.gain.exponentialRampToValueAtTime(0.001, time + dur);
    o.connect(filter).connect(g).connect(dest);
    o.start(time); o.stop(time+dur);
  }
}

/* ================= COMPONENT: KNOB ================= */
function createKnob(canvas, readoutEl, opts){
  const ctx = canvas.getContext('2d');
  const { min, max, initial, map, format, onChange } = opts;
  let value = initial;
  const w=canvas.width, h=canvas.height;
  
  function draw(){
    ctx.clearRect(0,0,w,h);
    const cx=w/2, cy=h/2, r=w/2-4;
    const startA = -2.5, endA = 0.9;
    const norm = (value - min) / (max - min);
    const angle = startA + norm * (endA - startA); 
    ctx.beginPath(); ctx.arc(cx,cy,r, startA, endA); 
    ctx.strokeStyle='rgba(255,255,255,0.1)'; ctx.lineWidth=5; ctx.stroke();
    ctx.beginPath(); ctx.arc(cx,cy,r, startA, angle); 
    ctx.strokeStyle='var(--neon)'; ctx.lineWidth=5; ctx.stroke();
  }
  function setVal(v){
    value = Math.max(min, Math.min(max, v));
    onChange(map(value));
    if(readoutEl) readoutEl.textContent = format(map(value));
    draw();
  }
  let isDrag=false, lastY=0;
  canvas.addEventListener('mousedown', e=>{ isDrag=true; lastY=e.clientY; });
  window.addEventListener('mouseup', ()=>isDrag=false);
  window.addEventListener('mousemove', e=>{
    if(!isDrag) return;
    const delta = (lastY - e.clientY) * ((max-min)/200);
    setVal(value + delta);
    lastY = e.clientY;
  });
  setVal(initial);
}

/* ================= UI GENERATION ================= */
const mixerEl = document.getElementById('mixer');

function createChannel(def, idx){
  const el = document.createElement('div'); el.className = 'strip';
  const gainNode = audioCtx.createGain();
  const filterNode = audioCtx.createBiquadFilter(); filterNode.type = 'lowpass'; filterNode.frequency.value = 20000;
  gainNode.connect(filterNode); filterNode.connect(limiter); filterNode.connect(delayInput); 

  const state = {
    ...def, gainNode, filterNode, index: idx,
    loopLen: 16, 
    steps: new Array(32).fill(false), // boolean on/off
    melody: new Array(32).fill(def.melodic ? SCALE_LABELS.length-1 : null), // stores Note Index (0-5)
    cells: [], muted: false, lastVol: 0.8,
    prCells: [] // piano roll cell references
  };

  // Header
  const head = document.createElement('div'); head.className='strip-header';
  const title = document.createElement('h2'); title.textContent = def.title; title.style.color = def.color;
  
  const tools = document.createElement('div'); tools.style.display='flex'; tools.style.gap='4px';
  
  if(def.melodic) {
    const btnEdit = document.createElement('button'); 
    btnEdit.className='tool-btn primary'; btnEdit.textContent='EDIT';
    btnEdit.onclick = () => openPianoRoll(state);
    tools.append(btnEdit);
  }

  const btnRnd = document.createElement('button'); btnRnd.className='tool-btn'; btnRnd.textContent='RND';
  const btnClr = document.createElement('button'); btnClr.className='tool-btn'; btnClr.textContent='CLR';
  tools.append(btnRnd, btnClr);
  
  head.append(title, tools); el.append(head);

  // Knobs
  const ctrls = document.createElement('div'); ctrls.className='controls-row';
  const d1 = document.createElement('div'); d1.className='knob-wrap';
  const c1 = document.createElement('canvas'); c1.className='knob'; c1.width=50; c1.height=50;
  const r1 = document.createElement('div'); r1.className='readout';
  d1.append(c1,r1);
  createKnob(c1, r1, { min:0, max:1.2, initial:0.8, map:v=>v, format:v=>(v*100).toFixed(0)+'%', onChange:v=>{ state.lastVol=v; if(!state.muted) gainNode.gain.value=v; }});
  
  const d2 = document.createElement('div'); d2.className='knob-wrap';
  const mBtn = document.createElement('button'); mBtn.className='mute'; mBtn.textContent='Mute';
  mBtn.onclick = () => { state.muted = !state.muted; mBtn.classList.toggle('muted', state.muted); gainNode.gain.value = state.muted ? 0 : state.lastVol; };
  d2.append(mBtn);
  ctrls.append(d1, d2); el.append(ctrls);

  // Grid
  const gridWrap = document.createElement('div'); gridWrap.className='grid-wrap';
  const grid = document.createElement('div'); grid.className='grid';
  for(let i=0; i<32; i++){
    const cell = document.createElement('div'); cell.className='cell';
    cell.onclick = () => { 
      state.steps[i] = !state.steps[i]; 
      cell.classList.toggle('active', state.steps[i]); 
    };
    grid.append(cell); state.cells.push(cell);
  }
  gridWrap.append(grid); el.append(gridWrap);

  // Loop Control
  const footer = document.createElement('div'); footer.className='loop-controls';
  const btnSub = document.createElement('button'); btnSub.className='tool-btn'; btnSub.textContent='-';
  const lblLen = document.createElement('span'); lblLen.className='loop-val'; lblLen.textContent = '16';
  const btnAdd = document.createElement('button'); btnAdd.className='tool-btn'; btnAdd.textContent='+';
  
  const updateLen = () => {
    lblLen.textContent = state.loopLen;
    state.cells.forEach((c,i) => {
      c.classList.toggle('beyond', i >= state.loopLen);
      if(i >= state.loopLen) c.classList.remove('playhead');
    });
    grid.style.gridTemplateColumns = `repeat(${state.loopLen}, 1fr)`;
  };
  
  btnSub.onclick = () => { if(state.loopLen > 1) state.loopLen--; updateLen(); };
  btnAdd.onclick = () => { if(state.loopLen < 32) state.loopLen++; updateLen(); };
  
  // Tools
  btnRnd.onclick = () => {
    state.cells.forEach((c,i) => {
      const active = i < state.loopLen && Math.random() > 0.7;
      state.steps[i] = active;
      // random melody note
      if(state.melodic) state.melody[i] = Math.floor(Math.random()*SCALE_LABELS.length);
      c.classList.toggle('active', active);
    });
  };
  btnClr.onclick = () => {
    state.cells.forEach((c,i) => { state.steps[i] = false; c.classList.remove('active'); });
  };

  footer.append(btnSub, lblLen, btnAdd); el.append(footer);
  mixerEl.append(el);
  channels.push(state);
  updateLen();
}

CHANNEL_DEFS.forEach((def, i) => createChannel(def, i));

/* ================= PIANO ROLL LOGIC ================= */
const modal = document.getElementById('pianoModal');
const prBody = document.getElementById('prBody');
const prTitle = document.getElementById('prTitle');

function openPianoRoll(channel){
  currentEditChannel = channel;
  prTitle.textContent = channel.title + " Melody";
  renderPianoGrid();
  modal.classList.add('open');
}

function closePianoRoll(){
  modal.classList.remove('open');
  currentEditChannel = null;
}

function renderPianoGrid(){
  prBody.innerHTML = '';
  const ch = currentEditChannel;
  if(!ch) return;

  // For every note in scale
  SCALE_LABELS.forEach((noteName, noteIndex) => {
    const row = document.createElement('div'); row.className = 'pr-row';
    
    // Label
    const key = document.createElement('div'); 
    key.className = 'pr-key' + (noteName.includes('#') ? ' black' : '');
    key.textContent = noteName;
    row.appendChild(key);

    // Cells
    const rowGrid = document.createElement('div'); rowGrid.className = 'pr-grid';
    
    for(let s=0; s<ch.loopLen; s++){
      const cell = document.createElement('div');
      cell.className = 'pr-cell';
      
      // Check if this step is active AND uses this note
      const isActive = ch.steps[s] && (ch.melody[s] === noteIndex);
      if(isActive) cell.classList.add('active');

      cell.onmousedown = () => {
        // Set this step to this note
        ch.steps[s] = true;
        ch.melody[s] = noteIndex;
        
        // Audio Preview
        triggerSound(ch.type, audioCtx.currentTime, ch.gainNode, SCALE_FREQS[noteIndex]);

        // Update UI (Piano Roll)
        // Clear other notes in this column visually
        const allCellsInCol = document.querySelectorAll(`.col-${s}`);
        allCellsInCol.forEach(c => c.classList.remove('active'));
        cell.classList.add('active');

        // Update Main Sequencer UI
        ch.cells[s].classList.add('active');
      };
      
      // Tag for easy selection
      cell.classList.add(`col-${s}`);
      cell.dataset.step = s;
      
      rowGrid.appendChild(cell);
    }
    row.appendChild(rowGrid);
    prBody.appendChild(row);
  });
}

/* ================= SEQUENCER ENGINE ================= */
let isPlaying = false;
let stepCounter = 0;
let nextNoteTime = 0;
let bpm = 120;
let swingAmount = 0;

const btnPlay = document.getElementById('playBtn');
const btnStop = document.getElementById('stopBtn');
const bpmIn = document.getElementById('bpmInput');

btnPlay.onclick = () => {
  if(audioCtx.state === 'suspended') audioCtx.resume();
  if(isPlaying) return;
  isPlaying = true; stepCounter = 0; nextNoteTime = audioCtx.currentTime + 0.05;
  btnPlay.classList.add('active');
  schedule();
};
btnStop.onclick = () => {
  isPlaying = false; btnPlay.classList.remove('active');
  channels.forEach(ch => ch.cells.forEach(c => c.classList.remove('playhead')));
  // Clear modal playheads too
  document.querySelectorAll('.pr-cell.playhead').forEach(c => c.classList.remove('playhead'));
};

document.getElementById('bpmUp').onclick = () => { bpm++; bpmIn.value=bpm; };
document.getElementById('bpmDown').onclick = () => { bpm--; bpmIn.value=bpm; };
document.getElementById('swingInput').oninput = (e) => swingAmount = parseFloat(e.target.value);

function schedule(){
  const secondsPerBeat = 60.0 / bpm;
  const stepTime = secondsPerBeat / 4; 

  while (nextNoteTime < audioCtx.currentTime + 0.1) {
    channels.forEach(ch => {
      const localStep = stepCounter % ch.loopLen;
      
      if (ch.steps[localStep]) {
        let freq = null;
        // Determine pitch
        if(ch.melodic && ch.melody[localStep] !== null) {
          freq = SCALE_FREQS[ch.melody[localStep]];
        }
        triggerSound(ch.type, nextNoteTime, ch.gainNode, freq);
        
        // Main Grid Flash
        const cell = ch.cells[localStep];
        requestAnimationFrame(() => {
          cell.classList.add('glow');
          setTimeout(() => cell.classList.remove('glow'), 150);
        });
      }
      
      // Visual Playhead (Main + Piano Roll)
      requestAnimationFrame(() => {
        ch.cells.forEach(c => c.classList.remove('playhead'));
        ch.cells[localStep].classList.add('playhead');

        // If Piano Roll is open for this channel, animate it
        if(currentEditChannel && currentEditChannel.id === ch.id) {
            document.querySelectorAll(`.pr-cell.playhead`).forEach(c => c.classList.remove('playhead'));
            // Highlight the entire column in the piano roll
            document.querySelectorAll(`.col-${localStep}`).forEach(c => c.classList.add('playhead'));
        }
      });
    });

    let swingDelay = 0;
    if (stepCounter % 2 !== 0) swingDelay = (secondsPerBeat / 4) * swingAmount;
    nextNoteTime += stepTime + swingDelay;
    stepCounter++;
  }
  if(isPlaying) requestAnimationFrame(schedule);
}
</script>
</body>
</html>
